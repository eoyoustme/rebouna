spawn(function() -- Bắt đầu một luồng riêng cho toàn bộ logic
    -- Định nghĩa VỊ TRÍ XUẤT HIỆN CỐ ĐỊNH của DEER.
    -- BẠN CẦN THAY ĐỔI giá trị Vector3.new(X, Y, Z) này thành tọa độ mong muốn của Deer.
    local deerSpawnPosition = Vector3.new(0, 10, -100) -- Vị trí ví dụ cho Deer

    -- Định nghĩa VỊ TRÍ XUẤT HIỆN CỐ ĐỊNH của NODE.
    -- BẠN CẦN THAY ĐỔI giá trị Vector3.new(X, Y, Z) này thành tọa độ mong muốn của Node.
    local nodeSpawnPosition = Vector3.new(0, 10, -100) -- Vị trí ví dụ cho Node (có thể giống hoặc khác Deer)

    -- Vòng lặp chính: Chạy mỗi 30 giây để kiểm soát sự kiện "Dear God"
    while task.wait(30) do
        -- Kiểm tra các điều kiện để bắt đầu sự kiện
        -- Nếu người chơi đang ở phòng 50, 100 hoặc LatestRoom là 6, chờ cho đến khi điều kiện này không còn đúng
        if workspace.CurrentRooms:FindFirstChild("50")
        or workspace.CurrentRooms:FindFirstChild("100")
        or game:GetService("ReplicatedStorage").GameData.LatestRoom.Value == 6 then
            print("Đang chờ điều kiện phòng thoát...")
            repeat task.wait() until not workspace.CurrentRooms:FindFirstChild("50")
                and not workspace.CurrentRooms:FindFirstChild("100")
                and not (game:GetService("ReplicatedStorage").GameData.LatestRoom.Value == 6)
            print("Điều kiện phòng đã được đáp ứng, bắt đầu sự kiện Deer/Node.")
        end

        -- Khởi tạo các biến cờ cho logic sự kiện
        local gotBadge = false
        local hit = false
        local found = false
        local isChasing = false
        local currentFollowSound = nil

        --- HIỆU ỨNG CAMERA RUNG LẮC (KHỞI ĐỘNG NGAY) ---
        local CameraShaker = require(game:GetService("ReplicatedStorage").CameraShaker)
        local camara = game.Workspace.CurrentCamera
        local camShake = CameraShaker.new(Enum.RenderPriority.Camera.Value, function(cf)
            camara.CFrame = camara.CFrame * cf
        end)
        camShake:Start()
        camShake:Shake(CameraShaker.Presets.Earthquake)
        print("Camera đang rung lắc.")

        --- HÀM TẢI ÂM THANH TỪ GITHUB (SỬ DỤNG HÀM EXPLOIT) ---
        local function GetGitSound(GithubSnd, SoundName)
            local url = GithubSnd
            if not isfile(SoundName .. ".mp3") then
                writefile(SoundName .. ".mp3", game:HttpGet(url))
                print("Đã tải âm thanh " .. SoundName .. " từ GitHub.")
            else
                print("Âm thanh " .. SoundName .. " đã tồn tại.")
            end
            local sound = Instance.new("Sound")
            sound.SoundId = (getcustomasset or getsynasset)(SoundName .. ".mp3")
            return sound
        end

        --- LẤY THÔNG TIN NGƯỜI CHƠI ---
        local Players = game:GetService("Players")
        local player = Players.LocalPlayer
        local character = player.Character or player.CharacterAdded:Wait()
        local HumanoidRootPart = character:WaitForChild("HumanoidRootPart")
        print("Đã lấy thông tin người chơi: " .. player.Name)

        --- TẢI VÀ KHỞI TẠO MODEL "DEER" ---
        -- Thay thế '86055776714285' bằng Asset ID thực của model Deer của bạn.
        local deer = game:GetObjects("rbxassetid://86055776714285")[1]
        deer.Parent = workspace
        deer.PrimaryPart = deer:FindFirstChildWhichIsA("BasePart")
        if not deer.PrimaryPart then
            warn("LỖI: Model 'Deer' không có PrimaryPart! Đảm bảo model có một BasePart làm PrimaryPart.")
            deer:Destroy()
            continue
        end
        deer.PrimaryPart.Anchored = true
        deer.PrimaryPart.CanCollide = false
        deer.Name = "Deer"
        local ambush = deer.PrimaryPart
        ambush.CFrame = CFrame.new(deerSpawnPosition)
        
        -- DEBUG: Đảm bảo Deer hiển thị
        for _, part in ipairs(deer:GetDescendants()) do
            if part:IsA("BasePart") then
                part.Transparency = 0 -- Đảm bảo không trong suốt
                print("Đã đặt độ trong suốt của " .. part.Name .. " (Deer) về 0.")
            end
        end

        print("Deer đã được spawn tại: " .. tostring(ambush.Position))
        task.wait()

        --- TẢI VÀ KHỞI TẠO "NODE" ENTITY (SỬ DỤNG LOADSTRING - HÀM EXPLOIT) ---
        task.spawn(function()
            local Spawner = loadstring(game:HttpGet('https://raw.githubusercontent.com/MuhXd/DoorSuff/main/OtherSuff/DoorEntitySpawn%2BSource'))()
            local entity = Spawner.createEntity({
                CustomName = "node",
                Model = "rbxassetid://83406552862223",
                Speed = 0, -- Giữ Speed = 0 để ta tự kiểm soát di chuyển của node qua RenderStepped
                DelayTime = 0, HeightOffset = 0, CanKill = false, NoDieOnCrouching = false, AntiCrucifix = true,
                KillRange = 0, OneRoom = false, DieOnLook = false, NoHiding = false, BreakLights = true,
                BackwardsMovement = false, FlickerLights = {true, 10}, Cycles = {Min = 1, Max = 1, WaitTime = 1},
                CamShake = {true, {3.5, 20, 0.1, 1}, 100}, Jumpscare = {false, {Type = "2", Image1 = "rbxassetid://10483855823", Image2 = "rbxassetid://10483999903", Shake = true, Sound1 = {"0", {Volume = 5}}, Sound2 = {"0", {Volume = 3}}, Flashing = {true, Color3.fromRGB(255, 255, 255)}, Tease = {true, Min = 1, Max = 3}}},
                Color = 'GuidingLight', DiffrentMessages = false,
                CustomDialog = {{"Claim has seen you.", "It will consume anyone on sight.", "It takes a bit to fully spawn in", "so you can use that to your advantage."},{"Stop Dieing"},{"Bruh", "Use what you have learned from Rush!"},{"It seems like Template is causing quite the ruckus...", "Hide in a closet or bed as quickly as possible!"},{"I have told You What to do", "YOU JUST HAVE A SKILL ISSUE"}}
            })

            entity.Debug.OnEntitySpawned = function()
                print("Entity 'node' đã spawn.")
                local nodeModel = workspace:FindFirstChild("node")
                if nodeModel and nodeModel:FindFirstChildOfClass("BasePart") then
                    nodeModel:FindFirstChildOfClass("BasePart").CFrame = CFrame.new(nodeSpawnPosition)
                    nodeModel:FindFirstChildOfClass("BasePart").Anchored = true -- Neo lại để nó không bị trôi

                    -- DEBUG: Đảm bảo Node hiển thị
                    for _, part in ipairs(nodeModel:GetDescendants()) do
                        if part:IsA("BasePart") then
                            part.Transparency = 0 -- Đảm bảo không trong suốt
                            print("Đã đặt độ trong suốt của " .. part.Name .. " (Node) về 0.")
                        end
                    end
                    print("Node đã được đặt tại: " .. tostring(nodeModel:FindFirstChildOfClass("BasePart").Position))
                else
                    warn("LỖI: Không tìm thấy PrimaryPart cho Node sau khi spawn!")
                end

                -- Vòng lặp này đảm bảo Node di chuyển cùng với Deer sau khi Deer bắt đầu đuổi theo
                game:GetService("RunService").RenderStepped:Connect(function()
                    if ambush and workspace:FindFirstChild("node") and workspace.node:FindFirstChildOfClass("BasePart") then
                        workspace.node:FindFirstChildOfClass("BasePart").CFrame = ambush.CFrame
                    end
                end)
            end
            Spawner.runEntity(entity)
        end)

        --- LOGIC KÍCH HOẠT ĐUỔI THEO KHI NGƯỜI CHƠI LẠI GẦN ---
        local detectionRange = 40 -- Phạm vi kích hoạt đuổi theo (40 stud)
        local isActivated = false

        task.spawn(function()
            while task.wait(0.5) do
                if not ambush or not HumanoidRootPart or not character then break end

                if not isActivated then
                    local distance = (ambush.Position - HumanoidRootPart.Position).Magnitude
                    print("Khoảng cách tới Deer: " .. math.floor(distance) .. " stud.") -- DEBUG: In ra khoảng cách
                    if distance <= detectionRange then
                        isActivated = true
                        print("Deer đã được kích hoạt và bắt đầu đuổi theo!")

                        currentFollowSound = GetGitSound("https://github.com/Tinkgy111/Bang/blob/main/followed.mp3?raw=true","chase")
                        if currentFollowSound then
                            currentFollowSound.Parent = deer
                            currentFollowSound.Volume = 1
                            currentFollowSound:Play()
                            print("Đã phát âm thanh đuổi theo.")
                        end
                        
                        isChasing = true -- ĐẶT isChasing = true TRƯỚC KHI TẠO LUỒNG ĐUỔI THEO

                        task.spawn(function()
                            local TweenService = game:GetService("TweenService")
                            local followTweenInfo = TweenInfo.new(1.5, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)

                            while isChasing do
                                if not ambush or not ambush.Parent or not character or not character.HumanoidRootPart then
                                    isChasing = false
                                    break
                                end
                                local currentHumanoidRootPart = character:FindFirstChild("HumanoidRootPart")
                                if not currentHumanoidRootPart then
                                    isChasing = false
                                    break
                                end

                                local targetCFrame = currentHumanoidRootPart.CFrame * CFrame.new(0, 0, -2)
                                targetCFrame = CFrame.new(targetCFrame.X, currentHumanoidRootPart.Position.Y + 7, targetCFrame.Z)

                                local followTween = TweenService:Create(ambush, followTweenInfo, {CFrame = targetCFrame})
                                followTween:Play()
                                task.wait(0.1)
                            end
                            if currentFollowSound and currentFollowSound.Playing then
                                currentFollowSound:Stop()
                            end
                            print("Logic đuổi theo đã dừng.")
                        end)
                    end
                end
            end
        end)

        --- LOGIC GÂY SÁT THƯƠNG KHI NHÌN VÀO DEER ---
        task.spawn(function()
            while task.wait(1.5) do
                if gotBadge == true or not isChasing then break end
                if not ambush or not HumanoidRootPart or not character or not character.Humanoid then break end

                local origin = ambush.Position
                local direction = (HumanoidRootPart.Position - origin).Unit
                local ray = Ray.new(origin, direction * 5050)
                local cast = workspace:Raycast(ray.Origin, ray.Direction)

                if cast and cast.Instance:IsDescendantOf(character) then
                    local look, onScreen = game.Workspace.CurrentCamera:WorldToScreenPoint(ambush.Position)
                    if onScreen then
                        character.Humanoid:TakeDamage(8)
                        print("Đã gây sát thương cho người chơi vì nhìn vào Deer.")
                    end
                end
            end
        end)

        --- LOGIC PHÁT HIỆN VA CHẠM VÀ JUMPSCARE ---
        task.spawn(function()
            local TweenService = game:GetService("TweenService")
            while task.wait(0.5) do
                if hit == true or not isChasing then break end
                if not ambush or not HumanoidRootPart or not character or not character.Humanoid then break end

                local hitbox = 9
                local origin = ambush.Position
                local direction = (HumanoidRootPart.Position - origin).Unit
                local ray = Ray.new(origin, direction * hitbox)
                local result = workspace:Raycast(ray.Origin, ray.Direction)

                if result and result.Instance:IsDescendantOf(character) then
                    found = true
                    hit = true
                    isChasing = false
                    print("Deer/Node đã va chạm với người chơi, bắt đầu jumpscare.")

                    if workspace:FindFirstChild("node") then workspace.node:Destroy() end
                    if currentFollowSound and currentFollowSound.Playing then currentFollowSound:Stop() end

                    local playergui = player:WaitForChild("PlayerGui")
                    local screenGui = Instance.new("ScreenGui")
                    screenGui.Parent = playergui; screenGui.Name = "Screen Gui"; screenGui.IgnoreGuiInset = true
                    local stop = false; local done = false

                    local killSound = Instance.new("Sound")
                    killSound.Parent = workspace; killSound.PlaybackSpeed = 3; killSound.SoundId = "rbxassetid://5263560896"
                    killSound.Name = "Dear god death sound chat"; killSound.Volume = 5; killSound.Looped = true
                    local flange = Instance.new("FlangeSoundEffect"); flange.Parent = killSound; flange.Depth = 1; flange.Mix = 1; flange.Rate = 0.2
                    local trem = Instance.new("TremoloSoundEffect"); trem.Parent = killSound; trem.Depth = 1; trem.Duty = 0.94; trem.Frequency = 20
                    local pitch = Instance.new("PitchShiftSoundEffect"); pitch.Parent = killSound; pitch.Octave = 0.5
                    local distort = Instance.new("DistortionSoundEffect"); distort.Parent = killSound; distort.Level = 0.98
                    killSound:Play()

                    local Backgroun = Instance.new("ImageLabel"); Backgroun.Parent = screenGui; Backgroun.Size = UDim2.new(1, 0, 1, 0); Backgroun.ImageTransparency = 1; Backgroun.BackgroundTransparency = 0; Backgroun.BackgroundColor3 = Color3.new(0, 0, 0); Backgroun.Image = "rbxassetid://105983470581183"
                    task.wait()
                    local face = Instance.new("ImageLabel"); face.Parent = screenGui; face.AnchorPoint = Vector2.new(0.5, 0.5); face.Position = UDim2.new(0.5, 0, 0.589, 0); face.Size = UDim2.new(0, 860, 0, 860); face.Image = "rbxassetid://73683518024275"; face.ImageTransparency = 0; face.BackgroundTransparency = 1
                    
                    task.spawn(function() while task.wait() do if stop == true then break end Backgroun.BackgroundTransparency = 0; Backgroun.ImageTransparency = 1; task.wait(0.1); Backgroun.BackgroundTransparency = 1; Backgroun.ImageTransparency = 0 end end)
                    task.spawn(function() while task.wait() do if stop == true then break end Backgroun.Image = "rbxassetid://131073231978514"; task.wait(0.0589); Backgroun.Image = "rbxassetid://105841646930424" end end)
                    task.spawn(function() while task.wait() do if stop == true then break end face.Rotation = 2; face.Image = "rbxassetid://122859819664215"; task.wait(0.0589); face.Rotation = -2; face.Image = "rbxassetid://84489429478798"; task.wait(0.0589); face.Rotation = 2; face.Image = "rbxassetid://73683518024275"; task.wait(0.0589); face.Rotation = -2 end end)

                    task.wait()
                    local text = Instance.new("ImageLabel"); text.Parent = screenGui; text.AnchorPoint = Vector2.new(0.5, 0.5); text.Position = UDim2.new(0.5, 0, 0.5, 0); text.Size = UDim2.new(0, 300, 0, 300); text.Image = "rbxassetid://117106082021449"; text.ImageTransparency = 0; text.BackgroundTransparency = 1
                    task.spawn(function() while task.wait() do if stop == true then break end text.Image = "rbxassetid://89229444931090"; task.wait(0.0589); text.Image = "rbxassetid://117106082021449" end end)
                    task.spawn(function() while task.wait() do if stop == true then break end text.Position = UDim2.new(Random.new():NextNumber(0, 0.5), 0, Random.new():NextNumber(0, 0.6), 0); task.wait(); text.Position = UDim2.new(Random.new():NextNumber(0, 0.5), 0, Random.new():NextNumber(0, 0.6), 0) end end)
                    task.spawn(function() while task.wait() do if stop == true then break end text.ImageTransparency = 0; task.wait(); text.ImageTransparency = 1 end end)

                    task.wait(1.6); stop = true; killSound:Stop(); task.wait()
                    task.spawn(function() while task.wait() do if done == true then break end face.ImageTransparency = 1; text.ImageTransparency = 1; Backgroun.ImageTransparency = 1; Backgroun.BackgroundTransparency = 1 end end)
                    task.wait(0.2)
                    if character and character.Humanoid then character.Humanoid.Health = 0 end
                    print("Người chơi đã chết.")
                    task.wait(3); done = true; screenGui:Destroy()
                end
            end
        end)

        --- CẬP NHẬT THÔNG TIN PHÒNG (Không dùng cho logic di chuyển của Deer nữa) ---
        local rooms = workspace.CurrentRooms
        local value = game:GetService("ReplicatedStorage").GameData.LatestRoom.Value
        local nextroom = rooms:FindFirstChild(value + 1)
        local room = rooms:FindFirstChild(value)
        local room1 = rooms:FindFirstChild(value - 1)
        local room2 = rooms:FindFirstChild(value - 2)
        local room3 = rooms:FindFirstChild(value - 3)
        local room4 = rooms:FindFirstChild(value - 4)
        local room5 = rooms:FindFirstChild(value - 5)

        game:GetService("ReplicatedStorage").GameData.LatestRoom.Changed:Connect(function()
            value = game:GetService("ReplicatedStorage").GameData.LatestRoom.Value
            nextroom = rooms:FindFirstChild(value + 1)
            room = rooms:FindFirstChild(value)
            room1 = rooms:FindFirstChild(value - 1)
            room2 = rooms:FindFirstChild(value - 2)
            room3 = rooms:FindFirstChild(value - 3)
            room4 = rooms:FindFirstChild(value - 4)
            room5 = rooms:FindFirstChild(value - 5)
        end)

        --- LOGIC KẾT THÚC VÀ HUY HIỆU ---
        task.spawn(function()
            task.wait(25) -- Thời gian tối đa cho event đuổi theo nếu không bị va chạm

            if found == false and isActivated == true then
                gotBadge = true
                print("Người chơi đã sống sót sau sự kiện Deer/Node.")
            else
                print("Sự kiện Deer/Node kết thúc, người chơi không sống sót hoặc không kích hoạt event.")
            end

            isChasing = false
            if deer and deer.Parent then deer:Destroy(); print("Đã hủy Deer.") end
            if workspace:FindFirstChild("node") and workspace.node.Parent then workspace.node:Destroy(); print("Đã hủy Node.") end
            if currentFollowSound and currentFollowSound.Playing then
                currentFollowSound:Stop()
                currentFollowSound:Destroy()
            end

            if gotBadge == true then
                local achievementGiver = loadstring(game:HttpGet("https://raw.githubusercontent.com/RegularVynixu/Utilities/main/Doors/Custom%20Achievements/Source.lua"))()
                achievementGiver({
                    Title = "Last Chance Too Look Away",
                    Desc = "Why are you running?",
                    Reason = "Survive the rare Entity called Dear God",
                    Image = "rbxassetid://114825307168774"
                })
                print("Đã cấp huy hiệu.")
            end
        end)

        task.wait(10)
        isChasing = false
        if deer and deer.Parent then deer:Destroy() end
        if workspace:FindFirstChild("node") and workspace.node.Parent then workspace.node:Destroy() end
        if currentFollowSound and currentFollowSound.Playing then
            currentFollowSound:Stop()
            currentFollowSound:Destroy()
        end
        print("Sự kiện Deer/Node đã hoàn tất chu kỳ. Chuẩn bị cho lần tiếp theo.")
    end
end)
