-- Kiểm tra kỹ model hợp lệ trước khi spawn
local ENTITY_MODEL_IDS = {
    "rbxassetid://129094269310068" -- Thay bằng ID đúng nếu cần
}

local GITHUB_SOUND_LINK = "https://github.com/Darker-TheDarkestGuy/DOORS/raw/refs/heads/main/XRecorder_Edited_20250622_01.mp3?raw=true"

local INITIAL_WALKSPEED = 16
local SPAWN_DISTANCE_BEHIND_PLAYER = 15
local SPAWN_IMMUNITY_DURATION = 5

local depthsTer = nil
local currentEntityModelID = nil
local playerHumanoid = nil

local function getRandomModelID()
    return ENTITY_MODEL_IDS[math.random(1, #ENTITY_MODEL_IDS)]
end

local function CustomGitSound(link)
    if not link or not link:match("^https?://") then return end
    local sound = Instance.new("Sound", workspace)
    sound.Name = "SpawnSound"
    sound.Volume = 6
    sound.SoundId = link
    pcall(function()
        sound.Loaded:Wait()
        if sound.IsLoaded then
            sound:Play()
        end
    end)
    sound.Ended:Connect(function() sound:Destroy() end)
end

local function spawnEntity()
    print("Đang gọi spawnEntity()")

    local player = game.Players.LocalPlayer
    if not player or not player.Character then return end

    local char = player.Character
    local hrp = char:FindFirstChild("HumanoidRootPart")
    playerHumanoid = char:FindFirstChildWhichIsA("Humanoid")

    if not hrp or not playerHumanoid then
        warn("Không có Humanoid hoặc HRP")
        return
    end

    local modelID = getRandomModelID()
    local success, model = pcall(function()
        return game:GetObjects(modelID)[1]
    end)

    if not success or not model then
        warn("Không thể tải mô hình từ ID:", modelID)
        return
    end

    depthsTer = model
    depthsTer.Parent = workspace

    local primary = depthsTer:FindFirstChildWhichIsA("BasePart")
    if not primary then
        warn("Model không có PrimaryPart!")
        depthsTer:Destroy()
        depthsTer = nil
        return
    end

    primary.CFrame = hrp.CFrame + (-hrp.CFrame.LookVector * SPAWN_DISTANCE_BEHIND_PLAYER) + Vector3.new(0, 5, 0)

    for _, part in ipairs(depthsTer:GetDescendants()) do
        if part:IsA("BasePart") then
            part.Anchored = false
            part.CanCollide = false
        end
    end

    CustomGitSound(GITHUB_SOUND_LINK)
    print("Obsession đã spawn thành công!")
end

-- Đảm bảo thực thể chỉ spawn nếu phòng phù hợp
local latestRoom = game.ReplicatedStorage:WaitForChild("GameData"):WaitForChild("LatestRoom").Value

if latestRoom < 50 or latestRoom > 100 then
    task.wait(2)
    spawnEntity()
else
    print("Không spawn trong phòng đặc biệt như Seek hoặc Figure.")
end
