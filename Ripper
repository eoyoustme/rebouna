---====== Load spawner ======---

local spawner = loadstring(game:HttpGet("https://raw.githubusercontent.com/RegularVynixu/Utilities/main/Doors/Entity%20Spawner/V2/Source.lua"))()

---====== Create entity ======---

local entity = spawner.Create({
    Entity = {
        Name = "Ripper",
        Asset = "rbxassetid://118750853123155",
        HeightOffset = 0
    },
    Lights = {
        Flicker = {
            Enabled = false,
            Duration = 1
        },
        Shatter = true,
        Repair = false
    },
    Earthquake = {
        Enabled = true
    },
    CameraShake = {
        Enabled = true,
        Range = 100,
        Values = {1.5, 20, 0.1, 1} -- Magnitude, Roughness, FadeIn, FadeOut
    },
    Movement = {
        Speed = 185,
        Delay = 5,
        Reversed = false
    },
    Rebounding = {
        Enabled = true,
        Type = "Ambush", -- "Blitz"
        Min = 1,
        Max = 1,
        Delay = 2
    },
    Damage = {
        Enabled = false,
        Range = 40,
        Amount = 125
    },
    Crucifixion = {
        Enabled = true,
        Range = 40,
        Resist = false,
        Break = true
    },
    Death = {
        Type = "Guiding", -- "Curious"
        Hints = {"Death", "Hints", "Go", "Here"},
        Cause = ""
    }
})

---====== Setup =======

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local isPlayerInHitbox = {}
local killTimers = {}

local function restorePlayer(player)
    local character = player.Character
    if character and character:FindFirstChild("Humanoid") then
        local humanoid = character.Humanoid
        humanoid.WalkSpeed = 16
        humanoid.JumpPower = 50
    end
    RunService:UnbindFromRenderStep("LockCamera_"..player.UserId)
    isPlayerInHitbox[player.UserId] = false
    killTimers[player.UserId] = 0
end

entity:SetCallback("OnStartMoving", function()
    spawn(function()
        while entity and entity:IsRunning() do
            wait(0.1)
            for _, player in pairs(Players:GetPlayers()) do
                local character = player.Character
                if character and character:FindFirstChild("HumanoidRootPart") and character:FindFirstChild("Humanoid") then
                    local hrp = character.HumanoidRootPart
                    local humanoid = character.Humanoid
                    local distance = (entity.Model.PrimaryPart.Position - hrp.Position).Magnitude
                    if distance <= 40 then -- Bỏ qua canKill, cứ trong hitbox là trigger
                        if not isPlayerInHitbox[player.UserId] then
                            isPlayerInHitbox[player.UserId] = true
                            killTimers[player.UserId] = 0

                            -- Khóa di chuyển
                            humanoid.WalkSpeed = 0
                            humanoid.JumpPower = 0

                            -- Khóa camera liên tục vào entity cách 6 stud trước camera player
                            local cam = workspace.CurrentCamera
                            RunService:BindToRenderStep("LockCamera_"..player.UserId, Enum.RenderPriority.Camera.Value + 1, function()
                                if not cam or not hrp or not entity.Model.PrimaryPart then
                                    RunService:UnbindFromRenderStep("LockCamera_"..player.UserId)
                                    return
                                end
                                local lookVector = cam.CFrame.LookVector
                                local newCamPos = hrp.Position + lookVector * 6
                                cam.CFrame = CFrame.new(newCamPos, entity.Model.PrimaryPart.Position)
                            end)

                            -- Bạn có thể thêm logic để entity lao tới camera player ở đây nếu muốn
                        end

                        killTimers[player.UserId] = killTimers[player.UserId] + 0.1
                        if killTimers[player.UserId] >= 2 then
                            humanoid.Health = 0
                            print(player.Name .. " đã bị Ripper giết!")
                            restorePlayer(player)
                        end
                    else
                        if isPlayerInHitbox[player.UserId] then
                            restorePlayer(player)
                        end
                    end
                end
            end
        end
    end)
end)

---====== Debug entity ======---

entity:SetCallback("OnSpawned", function()
    print("Entity has spawned")
    local cue2 = Instance.new("Sound")
    cue2.Parent = game.Workspace
    cue2.Name = "Spawn"
    cue2.SoundId = "rbxassetid://9125713501"
    cue2.Volume = 999
    cue2.PlaybackSpeed = 0.525
    cue2:Play()

    game.Lighting.MainColorCorrection.TintColor = Color3.fromRGB(255, 255, 255)
    game.Lighting.MainColorCorrection.Contrast = 10
    local tween = game:GetService("TweenService")
    tween:Create(game.Lighting.MainColorCorrection, TweenInfo.new(2.5), {Contrast = 0}):Play()
    local TweenService = game:GetService("TweenService")
    local TW = TweenService:Create(game.Lighting.MainColorCorrection, TweenInfo.new(5), {TintColor = Color3.fromRGB(250, 0, 0)})
    TW:Play()
    wait(0)
end)

entity:SetCallback("OnStartMoving", function()
    print("Entity has started moving")
end)

entity:SetCallback("OnEnterRoom", function(room, firstTime)
    if firstTime == true then
        print("Entity has entered room: ".. room.Name.. " for the first time")
    else
        print("Entity has entered room: ".. room.Name.. " again")
    end
end)

entity:SetCallback("OnLookAt", function(lineOfSight)
    if lineOfSight == true then
        print("Player is looking at entity")
    else
        print("Player view is obstructed by something")
    end
end)

entity:SetCallback("OnRebounding", function(startOfRebound)
    if startOfRebound == true then
        print("Entity has started rebounding")
    else
        print("Entity has finished rebounding")
    end
end)

entity:SetCallback("OnDespawning", function()
    print("Entity is despawning")
end)

entity:SetCallback("OnDespawned", function()
    print("Entity has despawned")
    local cue2 = Instance.new("Sound")
    cue2.Parent = game.Workspace
    cue2.Name = "Spawn"
    cue2.SoundId = "rbxassetid://1837829565"
    cue2.Volume = 9999
    cue2.PlaybackSpeed = 1
    cue2:Play()

    wait(3)
    game.Lighting.MainColorCorrection.TintColor = Color3.fromRGB(250, 0, 0)
    game.Lighting.MainColorCorrection.Contrast = 10
    local tween = game:GetService("TweenService")
    tween:Create(game.Lighting.MainColorCorrection, TweenInfo.new(2.5), {Contrast = 0}):Play()
    local TweenService = game:GetService("TweenService")
    local TW = TweenService:Create(game.Lighting.MainColorCorrection, TweenInfo.new(5), {TintColor = Color3.fromRGB(255, 255, 255)})
    TW:Play()
end)

entity:SetCallback("OnDamagePlayer", function(newHealth)
    if newHealth == 0 then
        print("Entity has killed the player")
    else
        print("Entity has damaged the player")
    end
end)

---====== Run entity ======---

entity:Run()
