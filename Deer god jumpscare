---====== Load spawner ======---

local spawner = loadstring(game:HttpGet("https://raw.githubusercontent.com/RegularVynixu/Utilities/main/Doors/Entity%20Spawner/V2/Source.lua"))()

---====== Services ======---
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local Debris = game:GetService("Debris")

---====== Player and Camera References ======---
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
local Camera = workspace.CurrentCamera

---====== State variables ======---
local entityModel -- Sẽ được gán là model "Deer god"
local entityPart -- Sẽ được gán là phần "RushNew" bên trong model
local chaseConnection = nil -- Biến để lưu trữ kết nối Heartbeat cho việc đuổi theo
local destroyTimer = nil -- Biến để lưu trữ timer tự hủy của Deer God

local customSpeed = 20 -- Tốc độ bạn muốn Deer God đuổi theo (từ code của bạn)
local MoveActive = true -- Biến kiểm soát việc di chuyển, tương tự Move của bạn

-- Lưu trữ trạng thái ánh sáng ban đầu (sẽ được cập nhật trong OnSpawned)
local originalTintColor
local originalContrast

---====== Create entity ======---

local entity = spawner.Create({
	Entity = {
		Name = "Deer god",
		Asset = "rbxassetid://75877292391257", -- ID Asset của model Deer god
		HeightOffset = 0
	},
	Lights = {
		Flicker = {
			Enabled = true, -- Giữ flicker nếu bạn muốn nó nhấp nháy
			Duration = 5
		},
		Shatter = true,
		Repair = false
	},
	Earthquake = {
		Enabled = false
	},
	CameraShake = {
		Enabled = true,
		Range = 100,
		Values = {1.5, 20, 0.1, 1} -- Magnitude, Roughness, FadeIn, FadeOut
	},
	Movement = {
		Speed = 0, -- Đặt tốc độ của spawner là 0 để chúng ta điều khiển bằng code Heartbeat
		Delay = 0, -- Đặt Delay về 0
		Reversed = false
	},
	Rebounding = {
		Enabled = false,
		Type = "Ambush",
		Min = 1,
		Max = 1,
		Delay = 2
	},
	Damage = {
		Enabled = true,
		Range = 40,
		Amount = 125
	},
	Crucifixion = {
		Enabled = true,
		Range = 40,
		Resist = false,
		Break = true
	},
	Death = {
		Type = "Guiding",
		Hints = {"ME GO PLAY SKIBIDI TOILET", "GOODBYE", "STUPID YOU DIE BY A WEAK ENTITY", "HERE IS NOT FOR NOOB"},
		Cause = ""
	}
})

---====== Debug entity and Custom Logic ======---

entity:SetCallback("OnSpawned", function()
    print("Entity has spawned")
    entityModel = entity.Model -- Gán mô hình "Deer god" khi nó spawn
    entityModel.Parent = workspace -- Đảm bảo Deer God nằm trong workspace nếu chưa

    -- *** ĐIỀU CHỈNH ĐỂ TÌM PHẦN "RushNew" và Đặt PrimaryPart ***
    if entityModel then
        entityPart = entityModel:FindFirstChild("RushNew")
        if not entityPart then
            warn("Deer God model does NOT contain a part named 'RushNew'!")
            -- Fallback: nếu không tìm thấy "RushNew", thử dùng PrimaryPart hoặc BasePart bất kỳ
            entityPart = entityModel.PrimaryPart or entityModel:FindFirstChildOfClass("BasePart")
            if not entityPart then
                warn("Could not find 'RushNew' or any suitable BasePart for Deer God!")
                return -- Không thể tiếp tục nếu không có phần nào để di chuyển
            end
        end
        -- Đặt PrimaryPart của model DeerGod
        entityModel.PrimaryPart = entityPart
        print("DeerGod.PrimaryPart set to: " .. entityModel.PrimaryPart.Name)

        -- Di chuyển Deer God đến vị trí ban đầu của bạn
        entityModel:SetPrimaryPartCFrame(HumanoidRootPart.CFrame * CFrame.new(0, 0, 50))
    else
        warn("entity.Model is nil after spawning! Cannot set up movement or sound.")
        return
    end

    -- --- Xóa âm mặc định của DeerGod (từ code của bạn) ---
    coroutine.wrap(function()
        for i, v in ipairs(entityModel:GetDescendants()) do
            if v.Name == "RushNew" then
                pcall(function()
                    if v:FindFirstChild("Breathing") then v.Breathing:Destroy() end
                end)
                pcall(function()
                    if v:FindFirstChild("Footsteps") then v.Footsteps:Destroy() end
                end)
            end
        end
    end)()

    -- --- Tải âm thanh từ GitHub và phát (từ code của bạn) ---
    local function GitAud(soundgit, filename)
        writefile(filename..".mp3", game:HttpGet(soundgit))
        return (getcustomasset or getsynasset)(filename..".mp3")
    end

    local function CustomGitSound(soundlink, vol, filename)
        local S = Instance.new("Sound")
        S.SoundId = GitAud(soundlink, filename)
        S.Volume = vol
        S.Looped = false
        S.Parent = entityModel -- Đặt Parent là entityModel
        S:Play()
        Debris:AddItem(S, S.TimeLength + 1) -- Đảm bảo âm thanh bị hủy sau khi phát xong
    end

    CustomGitSound("https://github.com/eoyoustme/Monoxide/blob/main/Hostile.mp3?raw=true", 2, "DeerGod_Hostile")

    -- Khởi tạo hoặc lấy ColorCorrectionEffect và lưu trạng thái ban đầu
    local colorCorrection = Lighting:FindFirstChildOfClass("ColorCorrectionEffect")
    if not colorCorrection then
        colorCorrection = Instance.new("ColorCorrectionEffect")
        colorCorrection.Name = "MainColorCorrection"
        colorCorrection.Parent = Lighting
    end
    originalTintColor = colorCorrection.TintColor
    originalContrast = colorCorrection.Contrast

    -- Hiệu ứng ánh sáng khi Deer God xuất hiện: ĐỎ và mờ dần
    colorCorrection.TintColor = Color3.fromRGB(255, 255, 255) -- Bắt đầu từ trắng
    colorCorrection.Contrast = 10 -- Contrast cao
    TweenService:Create(colorCorrection, TweenInfo.new(2.5), {Contrast = 0}):Play() -- Mờ contrast về 0
    TweenService:Create(colorCorrection, TweenInfo.new(5), {TintColor = Color3.fromRGB(250, 0, 0)}):Play() -- Mờ dần về đỏ

    -- --- Di chuyển theo người chơi bằng tốc độ cố định (từ code của bạn) ---
    MoveActive = true
    if chaseConnection then chaseConnection:Disconnect() end -- Ngắt kết nối cũ nếu có
    chaseConnection = RunService.Heartbeat:Connect(function(dt)
        if not MoveActive or not entityModel or not entityModel.PrimaryPart or not HumanoidRootPart or not HumanoidRootPart.Parent then return end
        local pos = entityModel.PrimaryPart.Position
        local target = HumanoidRootPart.Position
        local dir = (target - pos).Unit
        local moveVec = dir * customSpeed * dt
        local newCFrame = CFrame.new(pos + moveVec, target)
        entityModel:SetPrimaryPartCFrame(newCFrame)
    end)

    -- --- Tự huỷ sau 40–60 giây (từ code của bạn) ---
    if destroyTimer then task.cancel(destroyTimer) end -- Hủy timer cũ nếu có
    destroyTimer = task.delay(math.random(20, 40), function()
        MoveActive = false -- Ngừng di chuyển
        task.wait(0.5)
        if entityModel and entityModel.PrimaryPart then
            entityModel:SetPrimaryPartCFrame(entityModel.PrimaryPart.CFrame * CFrame.new(0, -100, 0)) -- Di chuyển xuống
        end
        task.wait(1)
        entity:Despawn() -- Sử dụng Despawn của Spawner để xử lý việc hủy bỏ và khôi phục ánh sáng
    end)

    -- Tạo va chạm gây sát thương (từ code của bạn)
    -- Gắn sự kiện Touched cho RushNew của model DeerGod đã spawn
    local spawnedRushNew = entityModel:FindFirstChild("RushNew")
    if spawnedRushNew then
        spawnedRushNew.Touched:Connect(function(hit)
            local h = hit.Parent and hit.Parent:FindFirstChild("Humanoid")
            if h and hit:IsDescendantOf(Character) then -- Sử dụng biến Character đã khai báo
                h:TakeDamage(10)
                local stats = game:GetService("ReplicatedStorage").GameStats
                if stats:FindFirstChild("Player_"..LocalPlayer.Name) then -- Sử dụng biến LocalPlayer
                    stats["Player_"..LocalPlayer.Name].Total.DeathCause.Value = "Pandemonium"
                end
            end
        end)
    else
        warn("Spawned Deer God model does not contain 'RushNew' for Touched event!")
    end

end)

entity:SetCallback("OnStartMoving", function()
    print("Entity has started moving (Spawner's callback, but movement is controlled by Heartbeat)")
end)

entity:SetCallback("OnEnterRoom", function(room, firstTime)
    if firstTime == true then
        print("Entity has entered room: ".. room.Name.. " for the first time")
    else
        print("Entity has entered room: ".. room.Name.. " again")
    end
end)

entity:SetCallback("OnLookAt", function(lineOfSight)
	if lineOfSight == true then
		print("Player is looking at entity")
	else
		print("Player view is obstructed by something")
	end
end)

entity:SetCallback("OnRebounding", function(startOfRebound)
    if startOfRebound == true then
        print("Entity has started rebounding")
	else
        print("Entity has finished rebounding")
	end
end)

entity:SetCallback("OnDespawning", function()
    print("Entity is despawning")
    -- Ngắt kết nối đuổi theo và timer tự hủy
    if chaseConnection then
        chaseConnection:Disconnect()
        chaseConnection = nil
    end
    if destroyTimer then
        task.cancel(destroyTimer)
        destroyTimer = nil
    end

    -- Khôi phục ánh sáng về trạng thái ban đầu khi despawn
    local colorCorrection = Lighting:FindFirstChildOfClass("ColorCorrectionEffect")
    if colorCorrection then
        TweenService:Create(colorCorrection, TweenInfo.new(2.5), {Contrast = originalContrast}):Play()
        TweenService:Create(colorCorrection, TweenInfo.new(5), {TintColor = originalTintColor}):Play()
    end

    -- Nếu Deer God đang bị neo, gỡ neo nó ra trước khi bị hủy
    if entityModel then
        for _, part in ipairs(entityModel:GetDescendants()) do
            if part:IsA("BasePart") then
                part.Anchored = false
            end
        end
        print("Entity has been unanchored before despawn.")
    end
end)

entity:SetCallback("OnDespawned", function()
    print("Entity has despawned")
    local cue2 = Instance.new("Sound")
    cue2.Parent = game.Workspace
    cue2.Name = "Spawn"
    cue2.SoundId = "rbxassetid://1837829565"
    cue2.Volume = 9999
    cue2.PlaybackSpeed = 1
    cue2:Play()
    Debris:AddItem(cue2, cue2.TimeLength + 1)
    task.wait(3)
end)

entity:SetCallback("OnDamagePlayer", function(newHealth)
	if newHealth == 0 then
		print("Entity has killed the player")

        -- UI Jumpscare Construction (Giữ nguyên code jumpscare của bạn)
        local playerGui = Players.LocalPlayer and Players.LocalPlayer:FindFirstChild("PlayerGui")
        if not playerGui then return end

        local JumpscareGui = Instance.new("ScreenGui")
        JumpscareGui.Name = "JumpscareGui"
        JumpscareGui.IgnoreGuiInset = true
        JumpscareGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        JumpscareGui.Parent = playerGui

        local Background = Instance.new("Frame")
        Background.Name = "Background"
        Background.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
        Background.BorderSizePixel = 0
        Background.Size = UDim2.new(1, 0, 1, 0)
        Background.ZIndex = 999
        Background.Parent = JumpscareGui

        local Face = Instance.new("ImageLabel")
        Face.Name = "Face"
        Face.AnchorPoint = Vector2.new(0.5, 0.5)
        Face.BackgroundTransparency = 1
        Face.Position = UDim2.new(0.5, 0, 0.5, 0)
        Face.ResampleMode = Enum.ResamplerMode.Pixelated
        Face.Size = UDim2.new(0, 150, 0, 150)
        Face.Image = "rbxassetid://12331751893"
        Face.ImageTransparency = 1
        Face.Parent = Background

        local scare = Instance.new("Sound")
        scare.Name = "MyEarsBurn"
        scare.SoundId = "rbxassetid://18459521002"
        scare.PlaybackSpeed = 1
        scare.Volume = 999
        scare.Parent = JumpscareGui

        task.spawn(function()
            while JumpscareGui.Parent do
                Background.BackgroundColor3 = Color3.fromRGB(50, 34, 232)
                task.wait(math.random(25, 100) / 1000)
                Background.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
                task.wait(math.random(25, 100) / 1000)
            end
        end)

        local initialFaceSize = Face.Size
        local initialFaceTransparency = Face.ImageTransparency

        local totalJumpscareDuration = 1.2
        local zoomInDuration = 1
        local rotationMagnitude = 10
        local rotationSpeed = 0.0001

        local startTime = tick()
        local connection

        connection = RunService.Heartbeat:Connect(function()
            local elapsed = tick() - startTime
            if not JumpscareGui.Parent or elapsed >= totalJumpscareDuration then
                if connection then connection:Disconnect() end
                JumpscareGui:Destroy()
                return
            end

            local zoomProgress = math.min(1, elapsed / zoomInDuration)

            local currentZoomScaleX = initialFaceSize.X.Scale + (1 - initialFaceSize.X.Scale) * zoomProgress
            local currentZoomOffsetX = initialFaceSize.X.Offset + (0 - initialFaceSize.X.Offset) * zoomProgress
            local currentZoomScaleY = initialFaceSize.Y.Scale + (1 - initialFaceSize.Y.Scale) * zoomProgress
            local currentZoomOffsetY = initialFaceSize.Y.Offset + (0 - initialFaceSize.Y.Offset) * zoomProgress

            Face.ImageTransparency = initialFaceTransparency - (initialFaceTransparency - 0) * zoomProgress

            Face.Size = UDim2.new(currentZoomScaleX, currentZoomOffsetX,
                                  currentZoomScaleY, currentZoomOffsetY)

            local rotationPhase = (elapsed / rotationSpeed) * math.pi * 2
            Face.Rotation = math.sin(rotationPhase) * rotationMagnitude
        end)

        scare:Play()

	else
		print("Entity has damaged the player")
	end
end)

---====== Run entity ======---

entity:Run()
