-- ===============================
-- Cấu hình Chung (General Configuration)
-- ===============================
local ENTITY_MODEL_IDS = {
    -- ID MÔ HÌNH THỰC TẾ BẠN ĐÃ CUNG CẤP
    "rbxassetid://101498124045552",
    "rbxassetid://129094269310068",
    "rbxassetid://129094269310068"
}

-- CẢNH BÁO CỰC KỲ QUAN TRỌNG:
-- Hàm này sẽ cố gắng sử dụng đường link GitHub trực tiếp.
-- Tuy nhiên, ROBLOX KHÔNG HỖ TRỢ ĐIỀU NÀY cho SoundId.
-- Dòng sound.SoundId = GitAud(soundlink, filename) SẼ GÂY LỖI
-- hoặc không tải được âm thanh vì GitAud không phải là hàm chuẩn của Roblox
-- và Roblox KHÔNG THỂ CHUYỂN ĐỔI LINK TRỰC TIẾP THÀNH ASSETID.
-- ĐÂY LÀ LÝ DO TẠI SAO BẠN CẦN TẢI LÊN ROBLOX STUDIO ĐỂ CÓ rbxassetid://
local function CustomGitSound(soundlink, vol, filename)
    local sound = Instance.new("Sound")
    -- Dòng này sẽ là vấn đề lớn nhất vì GitAud không định nghĩa và SoundId yêu cầu rbxassetid
    -- Tôi sẽ giữ nguyên theo yêu cầu của bạn, nhưng hãy lưu ý nó sẽ không hoạt động.
    sound.SoundId = GitAud(soundlink, filename) -- LỖI Ở ĐÂY NẾU GitAud KHÔNG TỒN TẠI HOẶC KHÔNG CHUYỂN ĐỔI ĐƯỢC ID
    sound.Parent = workspace
    sound.Volume = 6 -- Bạn muốn Volume cố định là 6
    sound.PlaybackSpeed = 1
    sound.Name = "Spawn" -- Bạn muốn tên là "Spawn" (đã thay đổi từ "DoorBreak" theo yêu cầu mới nhất)
    sound:Play()

    -- Xóa âm thanh sau khi kết thúc để tránh rò rỉ bộ nhớ
    task.spawn(function()
        sound.Ended:Wait()
        sound:Destroy()
    end)
end

-- Đường link GitHub bạn muốn sử dụng (sẽ được truyền vào CustomGitSound)
local GITHUB_SOUND_LINK = "https://github.com/Darker-TheDarkestGuy/DOORS/raw/refs/heads/main/XRecorder_Edited_20250622_01.mp3?raw=true"


local INITIAL_WALKSPEED = 16 -- Tốc độ đi bộ ban đầu của người chơi
local SLOWED_WALKSPEED = 12 -- Tốc độ đi bộ khi bị làm chậm
local TIME_TO_SLOWDOWN = 100 -- THAY ĐỔI: Thời gian không nhìn để bị làm chậm và đổi mô hình (giây)
local TIME_TO_DESPAWN_WHEN_LOOKING = 40 -- MỚI: Thời gian nhìn liên tục để thực thể biến mất (giây)
local SPAWN_RADIUS = 1 -- THAY ĐỔI: Khoảng cách tối đa từ người chơi để xuất hiện ngẫu nhiên (gần hơn)

-- ===============================
-- Các Biến Toàn Cục (Global Variables)
-- ===============================
local Kill = false -- Điều khiển vòng lặp kiểm tra thực thể
local depthsTer = nil -- Đối tượng thực thể Obsession hiện tại
local playerHumanoid = nil -- Humanoid của người chơi
local isPlayerSlowed = false -- Trạng thái người chơi có đang bị làm chậm không
local timeNotLooking = 30 -- Thời gian người chơi không nhìn vào thực thể
local timeLooking = 30 -- MỚI: Thời gian người chơi nhìn vào thực thể
local currentEntityModelID = nil -- ID mô hình hiện tại của thực thể Obsession

-- ===============================
-- Hàm Hỗ Trợ (Helper Functions)
-- ===============================

-- Hàm để lấy một ID mô hình ngẫu nhiên từ danh sách ENTITY_MODEL_IDS
local function getRandomModelID()
    local randomIndex = math.random(1, #ENTITY_MODEL_IDS)
    return ENTITY_MODEL_IDS[randomIndex]
end

-- Hàm trợ giúp để kích hoạt sự kiện client (như DeathHint)
local function fireLocalSignal(event, ...)
    if event and typeof(event) == "RBXScriptSignal" then
        event:Fire(...)
    elseif event and event.Fire then
        warn("Event may be a custom wrapper or does not directly support :Fire():", event)
    else
        warn("Attempted to fire an invalid event:", event)
    end
end

-- ===============================
-- Logic Thực Thể Obsession
-- ===============================

-- Hàm để tạo thực thể Obsession
local function spawnEntity()
    -- Dọn dẹp thực thể cũ nếu có
    if depthsTer then
        despawnEntity() -- Dùng hàm despawn để đảm bảo dọn dẹp đầy đủ
    end

    local character = game.Players.LocalPlayer.Character
    if not character or not character:FindFirstChildOfClass("HumanoidRootPart") then return end
    playerHumanoid = character:FindFirstChildOfClass("Humanoid")
    if not playerHumanoid then return end

    -- Chọn ID mô hình mới, đảm bảo nó không giống với ID hiện tại (nếu có nhiều hơn 1 ID)
    local newModelID = getRandomModelID()
    if currentEntityModelID and #ENTITY_MODEL_IDS > 1 then
        while newModelID == currentEntityModelID do
            newModelID = getRandomModelID()
        end
    end
    currentEntityModelID = newModelID

    -- Tải mô hình từ ID
    depthsTer = game:GetObjects(currentEntityModelID)[1]
    depthsTer.Parent = game.Workspace

    -- Tìm phần chính của mô hình để định vị
    local primaryPart = depthsTer:FindFirstChildWhichIsA("BasePart") or depthsTer:FindFirstChildWhichIsA("Part")
    if not primaryPart then
        warn("Không tìm thấy phần chính trong mô hình thực thể đã tải. Xóa thực thể.")
        despawnEntity() -- Dọn dẹp nếu không tìm thấy PrimaryPart
        return
    end

    -- Vị trí ngẫu nhiên xung quanh người chơi
    local randomOffset = Vector3.new(math.random(-SPAWN_RADIUS, SPAWN_RADIUS), 0, math.random(-SPAWN_RADIUS, SPAWN_RADIUS))
    primaryPart.CFrame = character.HumanoidRootPart.CFrame + randomOffset + Vector3.new(0, 5, 0) -- Hơi cao hơn sàn

    -- Đảm bảo các phần của mô hình không chặn người chơi
    for _, part in pairs(depthsTer:GetDescendants()) do
        if part:IsA("BasePart") then
            part.Anchored = false
            part.CanCollide = false
        end
    end

    Kill = true -- Kích hoạt vòng lặp kiểm tra
    timeNotLooking = 0 -- Reset thời gian không nhìn
    timeLooking = 0 -- MỚI: Reset thời gian nhìn
    isPlayerSlowed = false -- Reset trạng thái làm chậm
    playerHumanoid.WalkSpeed = INITIAL_WALKSPEED -- Khôi phục tốc độ ban đầu

    print("Thực thể Obsession được tạo với ID mô hình:", currentEntityModelID)
    -- Gọi hàm CustomGitSound mà bạn muốn sử dụng
    CustomGitSound(GITHUB_SOUND_LINK, 1, "Spawn")
end

-- Hàm để loại bỏ thực thể Obsession
local function despawnEntity()
    if depthsTer then
        depthsTer:Destroy()
        depthsTer = nil
    end
    Kill = false
    timeNotLooking = 0
    timeLooking = 0 -- MỚI: Reset thời gian nhìn khi biến mất
    if isPlayerSlowed and playerHumanoid then -- Chỉ khôi phục nếu thực sự bị làm chậm
        playerHumanoid.WalkSpeed = INITIAL_WALKSPEED
        isPlayerSlowed = false
    end
    currentEntityModelID = nil -- Reset ID mô hình hiện tại
    print("Thực thể Obsession đã biến mất.")
end

-- ===============================
-- Vòng Lặp Chính & Xử Lý Sự Kiện (Main Loop & Event Handling)
-- ===============================

task.spawn(function()
    local player = game.Players.LocalPlayer
    if player and player.Character then
        playerHumanoid = player.Character:FindFirstChildOfClass("Humanoid")
        if playerHumanoid then
            playerHumanoid.WalkSpeed = INITIAL_WALKSPEED -- Đảm bảo tốc độ ban đầu khi script bắt đầu
        end
    end

    while true do
        task.wait(0.1) -- Kiểm tra mỗi 0.1 giây để phản hồi tốt

        -- Đảm bảo các biến cần thiết tồn tại và người chơi còn sống
        if Kill and depthsTer and playerHumanoid and playerHumanoid.Health > 0 then
            -- Kiểm tra xem người chơi có đang nhìn vào thực thể không
            local _, cameraVisible = game.Workspace.CurrentCamera:WorldToViewportPoint(depthsTer.PrimaryPart.Position)

            if not cameraVisible then
                -- Người chơi KHÔNG nhìn vào thực thể
                timeNotLooking = timeNotLooking + 0.1 -- Tăng thời gian không nhìn
                timeLooking = 0 -- MỚI: Reset thời gian nhìn khi không nhìn

                if timeNotLooking >= TIME_TO_SLOWDOWN then
                    -- Làm chậm người chơi nếu chưa bị làm chậm
                    if not isPlayerSlowed then
                        playerHumanoid.WalkSpeed = SLOWED_WALKSPEED
                        isPlayerSlowed = true
                        print("Người chơi bị làm chậm!")
                    end

                    -- THAY ĐỔI: Thực thể biến mất sau khi làm chậm nếu không nhìn đủ lâu
                    -- Điều kiện `math.abs(timeNotLooking % TIME_TO_SLOWDOWN) < 0.1` được giữ nguyên
                    -- để kích hoạt chỉ một lần khi vượt ngưỡng hoặc cứ mỗi ngưỡng.
                    -- Với yêu cầu mới "và nó sẽ biến mất", chúng ta chỉ cần nó biến mất sau 3.4 giây
                    -- không nhìn, không cần đổi model liên tục nữa.
                    -- Nếu bạn muốn nó vẫn đổi model trước khi biến mất, cần thêm logic.
                    print("Không nhìn đủ lâu (" .. timeNotLooking .. "s), thực thể biến mất!")
                    despawnEntity()
                    task.wait(2) -- Đợi một chút trước khi tạo mô hình mới
                    spawnEntity()
                end
            else
                -- Người chơi ĐANG nhìn vào thực thể
                timeLooking = timeLooking + 0.1 -- MỚI: Tăng thời gian nhìn
                timeNotLooking = 0 -- Reset thời gian không nhìn

                -- MỚI: Nếu nhìn đủ 4 giây, thực thể biến mất
                if timeLooking >= TIME_TO_DESPAWN_WHEN_LOOKING then
                    if isPlayerSlowed then
                        playerHumanoid.WalkSpeed = INITIAL_WALKSPEED
                        isPlayerSlowed = false
                        print("Tốc độ người chơi được khôi phục!")
                    end
                    print("Người chơi nhìn đủ lâu (" .. timeLooking .. "s), thực thể biến mất!")
                    despawnEntity()
                    task.wait(2) -- Thêm độ trễ ngắn trước khi tạo lại
                    spawnEntity() -- Tạo lại ngay lập tức
                else
                    -- Nếu đang nhìn nhưng chưa đủ 4 giây
                    if isPlayerSlowed then
                        playerHumanoid.WalkSpeed = INITIAL_WALKSPEED
                        isPlayerSlowed = false
                        print("Tốc độ người chơi được khôi phục!")
                    end
                    -- Không làm gì khác, tiếp tục đợi người chơi nhìn đủ thời gian
                end
            end

            -- Kiểm tra nếu người chơi chết
            if playerHumanoid.Health <= 0 then
                fireLocalSignal(game.ReplicatedStorage.RemotesFolder.DeathHint.OnClientEvent, {"Bạn đã bị Obsession nuốt chửng...", "Hãy nhìn vào nó để nó biến mất, nếu không bạn sẽ chậm lại và bị áp đảo!", "Nó thay đổi hình dạng liên tục."}, "Red")
                task.wait(0.01)
                if game:GetService("ReplicatedStorage").GameStats["Player_" .. player.Name] then
                    game:GetService("ReplicatedStorage").GameStats["Player_" .. player.Name].Total.DeathCause.Value = "Obsession"
                end
                despawnEntity()
                break -- Thoát vòng lặp chính khi người chơi chết
            end
        elseif playerHumanoid and playerHumanoid.Health <= 0 then
            despawnEntity() -- Dọn dẹp nếu người chơi chết vì nguyên nhân khác
            break -- Thoát vòng lặp chính
        end
    end
end)

-- ===============================
-- Khởi Tạo Ban Đầu (Initial Setup)
-- ===============================

-- Kiểm tra phòng hiện tại để quyết định có nên tạo thực thể không
local entityModelAllowed = true
local latestRoom = game.ReplicatedStorage.GameData.LatestRoom.Value

-- Không tạo thực thể nếu ở trong Seek, Figure, hoặc Phòng 90-100
if game.Workspace:FindFirstChild("SeekMovingNewClone") or
    latestRoom == 50 or latestRoom == 100 or
    (latestRoom >= 90 and latestRoom <= 100) then
    entityModelAllowed = false
end

-- Bắt đầu nếu được phép
if entityModelAllowed then
    task.wait(1) -- Đợi một chút để người chơi tải vào game
    spawnEntity()
end

-- Lắng nghe sự kiện thay đổi phòng để loại bỏ thực thể
game.ReplicatedStorage.GameData.LatestRoom.Changed:Connect(function()
    despawnEntity()
    -- Bạn có thể thêm logic ở đây để quyết định xem có nên tạo lại thực thể trong phòng mới không
    -- dựa trên số phòng
end)
